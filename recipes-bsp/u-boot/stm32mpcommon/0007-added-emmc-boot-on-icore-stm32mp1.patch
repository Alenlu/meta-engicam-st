From ad24688861dbfb40d83c12d8d0ef776e38273fd9 Mon Sep 17 00:00:00 2001
From: Matteo Lisi <matteo.lisi@engicam.com>
Date: Tue, 21 May 2019 11:26:13 +0200
Subject: [PATCH] added emmc boot on icore stm32mp1

---
 arch/arm/dts/stm32mp15-mx.h                   | 48 +++++++++----------
 .../dts/stm32mp157a-icorestm32-mx-u-boot.dtsi | 39 ++++++++-------
 arch/arm/dts/stm32mp157a-icorestm32-mx.dts    | 27 ++++++-----
 board/st/stm32mp1/README                      |  4 +-
 configs/stm32mp15_icorest_trusted_defconfig   |  2 +
 include/configs/stm32mp1-icore.h              |  1 +
 6 files changed, 64 insertions(+), 57 deletions(-)

diff --git a/arch/arm/dts/stm32mp15-mx.h b/arch/arm/dts/stm32mp15-mx.h
index 0578849..905ee9b 100644
--- a/arch/arm/dts/stm32mp15-mx.h
+++ b/arch/arm/dts/stm32mp15-mx.h
@@ -8,20 +8,20 @@
 /*
  * File generated by STMicroelectronics STM32CubeMX DDR Tool for MPUs
  * DDR type: DDR3 / DDR3L
- * DDR width: 16bits
- * DDR density: 2Gb
+ * DDR width: 32bits
+ * DDR density: 4Gb
  * System frequency: 528000Khz
  * Relaxed Timing Mode: false
  * Address mapping type: RBC
  *
- * Save Date: 2019.03.07, save Time: 11:25:13
+ * Save Date: 2019.05.14, save Time: 11:25:16
  */
 
-#define DDR_MEM_NAME	"DDR3-DDR3L 16bits 528000Khz"
+#define DDR_MEM_NAME	"DDR3-DDR3L 32bits 528000Khz"
 #define DDR_MEM_SPEED	528000
-#define DDR_MEM_SIZE	0x10000000
+#define DDR_MEM_SIZE	0x20000000
 
-#define DDR_MSTR 0x00041401
+#define DDR_MSTR 0x00040401
 #define DDR_MRCTRL0 0x00000010
 #define DDR_MRCTRL1 0x00000000
 #define DDR_DERATEEN 0x00000000
@@ -34,17 +34,17 @@
 #define DDR_RFSHTMG 0x0080008A
 #define DDR_CRCPARCTL0 0x00000000
 #define DDR_DRAMTMG0 0x121B2414
-#define DDR_DRAMTMG1 0x000A041C
-#define DDR_DRAMTMG2 0x0608090F
+#define DDR_DRAMTMG1 0x000A041B
+#define DDR_DRAMTMG2 0x0607080F
 #define DDR_DRAMTMG3 0x0050400C
-#define DDR_DRAMTMG4 0x08040608
+#define DDR_DRAMTMG4 0x07040607
 #define DDR_DRAMTMG5 0x06060403
 #define DDR_DRAMTMG6 0x02020002
 #define DDR_DRAMTMG7 0x00000202
 #define DDR_DRAMTMG8 0x00001005
 #define DDR_DRAMTMG14 0x000000A0
 #define DDR_ZQCTL0 0xC2000040
-#define DDR_DFITMG0 0x02060105
+#define DDR_DFITMG0 0x02050105
 #define DDR_DFITMG1 0x00000202
 #define DDR_DFILPCFG0 0x07000000
 #define DDR_DFIUPD0 0xC0400003
@@ -75,12 +75,12 @@
 #define DDR_PCFGQOS1_1 0x00800040
 #define DDR_PCFGWQOS0_1 0x01100C03
 #define DDR_PCFGWQOS1_1 0x01000200
-#define DDR_ADDRMAP1 0x00070707
+#define DDR_ADDRMAP1 0x00080808
 #define DDR_ADDRMAP2 0x00000000
-#define DDR_ADDRMAP3 0x1F000000
+#define DDR_ADDRMAP3 0x00000000
 #define DDR_ADDRMAP4 0x00001F1F
-#define DDR_ADDRMAP5 0x06060606
-#define DDR_ADDRMAP6 0x0F0F0606
+#define DDR_ADDRMAP5 0x07070707
+#define DDR_ADDRMAP6 0x0F0F0707
 #define DDR_ADDRMAP9 0x00000000
 #define DDR_ADDRMAP10 0x00000000
 #define DDR_ADDRMAP11 0x00000000
@@ -92,10 +92,10 @@
 #define DDR_DXCCR 0x00000C40
 #define DDR_DSGCR 0xF200001F
 #define DDR_DCR 0x0000000B
-#define DDR_DTPR0 0x38D488D0
+#define DDR_DTPR0 0x36D477D0
 #define DDR_DTPR1 0x098A00D8
 #define DDR_DTPR2 0x10023600
-#define DDR_MR0 0x00000840
+#define DDR_MR0 0x00000830
 #define DDR_MR1 0x00000000
 #define DDR_MR2 0x00000208
 #define DDR_MR3 0x00000000
@@ -109,11 +109,11 @@
 #define DDR_DX1DLLCR 0x40000000
 #define DDR_DX1DQTR 0xFFFFFFFF
 #define DDR_DX1DQSTR 0x3DB02000
-#define DDR_DX2GCR 0x00000000
-#define DDR_DX2DLLCR 0x00000000
-#define DDR_DX2DQTR 0x00000000
-#define DDR_DX2DQSTR 0x00000000
-#define DDR_DX3GCR 0x00000000
-#define DDR_DX3DLLCR 0x00000000
-#define DDR_DX3DQTR 0x00000000
-#define DDR_DX3DQSTR 0x00000000
+#define DDR_DX2GCR 0x0000CE81
+#define DDR_DX2DLLCR 0x40000000
+#define DDR_DX2DQTR 0xFFFFFFFF
+#define DDR_DX2DQSTR 0x3DB02000
+#define DDR_DX3GCR 0x0000CE81
+#define DDR_DX3DLLCR 0x40000000
+#define DDR_DX3DQTR 0xFFFFFFFF
+#define DDR_DX3DQSTR 0x3DB02000
diff --git a/arch/arm/dts/stm32mp157a-icorestm32-mx-u-boot.dtsi b/arch/arm/dts/stm32mp157a-icorestm32-mx-u-boot.dtsi
index 613e3af..0bbbbbd 100644
--- a/arch/arm/dts/stm32mp157a-icorestm32-mx-u-boot.dtsi
+++ b/arch/arm/dts/stm32mp157a-icorestm32-mx-u-boot.dtsi
@@ -22,19 +22,20 @@ clocks {
     /* USER CODE BEGIN clocks */
     /* USER CODE END clocks */
 
-    clk_lsi: clk-lsi {
+    clk_hsi: clk-hsi {
         /* USER CODE BEGIN clocks */
         /* USER CODE END clocks */
         u-boot,dm-pre-reloc;
     };
-    clk_hsi: clk-hsi {
+    clk_csi: clk-csi {
         /* USER CODE BEGIN clocks */
         /* USER CODE END clocks */
         u-boot,dm-pre-reloc;
     };
-    clk_csi: clk-csi {
+    clk_lse: clk-lse {
         /* USER CODE BEGIN clocks */
         /* USER CODE END clocks */
+        st,drive=<LSEDRV_MEDIUM_HIGH>;
         u-boot,dm-pre-reloc;
     };
     clk_hse: clk-hse {
@@ -99,33 +100,34 @@ clocks {
     u-boot,dm-pre-reloc;
     st,clksrc = <
         CLK_MPU_PLL1P
-        CLK_AXI_HSI
+        CLK_AXI_PLL2P
         CLK_MCU_PLL3P
         CLK_PLL12_HSI
-        CLK_PLL3_HSI
-        CLK_PLL4_HSI
-        CLK_RTC_LSI
+        CLK_PLL3_HSE
+        CLK_PLL4_HSE
+        CLK_RTC_LSE
         CLK_MCO1_DISABLED
         CLK_MCO2_DISABLED
     >;
     st,clkdiv = <
         1         /*MPU*/
-        0         /*AXI*/
+        1         /*AXI*/
         0         /*MCU*/
         1         /*APB1*/
         1         /*APB2*/
         1         /*APB3*/
         0         /*APB4*/
-        0         /*APB5*/
+        1         /*APB5*/
         0         /*RTC*/
         0         /*MCO1*/
         0         /*MCO2*/
     >;
     st,pkcs = <
-        CLK_CKPER_HSI
+        CLK_CKPER_DISABLED
         CLK_FMC_ACLK
         CLK_ETH_PLL3Q
-        CLK_SDMMC12_HCLK6
+        CLK_SDMMC12_HSI
+        CLK_DSI_DSIPLL
         CLK_STGEN_HSI
         CLK_USBPHY_HSE
         CLK_SPI2S1_DISABLED
@@ -135,19 +137,19 @@ clocks {
         CLK_I2C46_CSI
         CLK_SDMMC3_DISABLED
         CLK_USBO_USBPHY
-        CLK_ADC_DISABLED
+        CLK_ADC_PLL4R
         CLK_CEC_DISABLED
         CLK_I2C12_PCLK1
         CLK_I2C35_DISABLED
         CLK_UART1_DISABLED
-        CLK_UART24_PCLK1
+        CLK_UART24_HSE
         CLK_UART35_DISABLED
         CLK_UART6_DISABLED
         CLK_UART78_DISABLED
         CLK_SPDIF_DISABLED
         CLK_FDCAN_HSE
-        CLK_SAI1_DISABLED
-        CLK_SAI2_CKPER
+        CLK_SAI1_PLL4Q
+        CLK_SAI2_PLL3Q
         CLK_SAI3_DISABLED
         CLK_SAI4_DISABLED
         CLK_LPTIM1_DISABLED
@@ -159,15 +161,16 @@ clocks {
         u-boot,dm-pre-reloc;
     };
     pll2:st,pll@1 {
-        cfg = < 3 29 1 0 0 6>;
+        cfg = < 3 32 1 0 0 7>;
         u-boot,dm-pre-reloc;
     };
     pll3:st,pll@2 {
-        cfg = < 3 24 1 7 1 3>;
+        cfg = < 1 49 2 11 1 3>;
         u-boot,dm-pre-reloc;
     };
     pll4:st,pll@3 {
-        cfg = < 3 24 1 4 0 2>;
+        cfg = < 1 32 3 4 3 2>;
+        frac = < 2731 >;
         u-boot,dm-pre-reloc;
     };
 };
diff --git a/arch/arm/dts/stm32mp157a-icorestm32-mx.dts b/arch/arm/dts/stm32mp157a-icorestm32-mx.dts
index 519c103..deaf779 100644
--- a/arch/arm/dts/stm32mp157a-icorestm32-mx.dts
+++ b/arch/arm/dts/stm32mp157a-icorestm32-mx.dts
@@ -85,7 +85,7 @@
 						 <STM32_PINMUX('C', 4, AF11)>, /* ETH_RX_D0 */
 						 <STM32_PINMUX('C', 5, AF11)>, /* ETH_RX_D1 */
 						 <STM32_PINMUX('G', 13, AF11)>, /* ETH_TX_D0 */
-						 <STM32_PINMUX('G', 14, AF11)>, /* ETH_TX_D1 */						 
+						 <STM32_PINMUX('G', 14, AF11)>, /* ETH_TX_D1 */
 						 <STM32_PINMUX('D', 10, GPIO)>;
 					bias-disable;
 					drive-push-pull;
@@ -97,7 +97,7 @@
                     bias-pull-up;
                     drive-push-pull;
                     output-low;
-                    slew-rate = <0>;				
+                    slew-rate = <0>;
 				};
     };
 
@@ -205,18 +205,18 @@
         u-boot,dm-pre-reloc;
         pins1 {
             u-boot,dm-pre-reloc;
-            pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
-                     <STM32_PINMUX('A', 9, AF10)>, /* SDMMC2_D5 */
-                     <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
-                     <STM32_PINMUX('B', 4, AF9)>, /* SDMMC2_D3 */
-                     <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
-                     <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
-                     <STM32_PINMUX('D', 3, AF9)>, /* SDMMC2_D7 */
-                     <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
-                     <STM32_PINMUX('G', 6, AF10)>; /* SDMMC2_CMD */
-            bias-disable;
+            pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
+                    <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
+                    <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
+                    <STM32_PINMUX('B', 4, AF9)>, /* SDMMC2_D3 */
+                    <STM32_PINMUX('G', 6, AF10)>, /* SDMMC2_CMD */
+                    <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
+                    <STM32_PINMUX('A', 9, AF10)>, /* SDMMC2_D5 */
+                    <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
+                    <STM32_PINMUX('D', 3, AF9)>; /* SDMMC2_D7 */
+            slew-rate = <3>;
             drive-push-pull;
-            slew-rate = <1>;
+            bias-pull-up;
         };
         pins2 {
             u-boot,dm-pre-reloc;
@@ -226,6 +226,7 @@
             slew-rate = <3>;
         };
     };
+
     uart4_pins_mx: uart4_mx-0 {
         u-boot,dm-pre-reloc;
         pins1 {
diff --git a/board/st/stm32mp1/README b/board/st/stm32mp1/README
index 4ebcfb4..efeaa1d 100644
--- a/board/st/stm32mp1/README
+++ b/board/st/stm32mp1/README
@@ -261,7 +261,7 @@ a) prepare GPT on eMMC,
 b) copy SPL on eMMC on firts boot partition
 	(SPL max size is 256kB, with LBA 512, 0x200)
 
-	# ext4load mmc 0:4 0xC0000000 u-boot-spl.stm32
+	# ext4load mmc 0:6 0xC0000000 tf-a-stm32mp157a-icorestm32-mx.stm32
 	# mmc dev 1
 	# mmc partconf 1 1 1 1
 	# mmc write ${fileaddr} 0 200
@@ -269,7 +269,7 @@ b) copy SPL on eMMC on firts boot partition
 
 b) copy U-Boot in first GPT partition of eMMC
 
-	# ext4load mmc 0:4 0xC0000000 u-boot.img
+	# ext4load mmc 0:6 0xC0000000 u-boot.stm32
 	# mmc dev 1
 	# part start mmc 1 1 partstart
 	# part size mmc 1 1 partsize
diff --git a/configs/stm32mp15_icorest_trusted_defconfig b/configs/stm32mp15_icorest_trusted_defconfig
index 535f13b..f1c4b10 100644
--- a/configs/stm32mp15_icorest_trusted_defconfig
+++ b/configs/stm32mp15_icorest_trusted_defconfig
@@ -51,6 +51,8 @@ CONFIG_DM_MAILBOX=y
 CONFIG_STM32_IPCC=y
 CONFIG_DM_MMC=y
 CONFIG_STM32_SDMMC2=y
+CONFIG_SUPPORT_EMMC_BOOT=y
+CONFIG_CMD_GPT=y
 CONFIG_MTD=y
 CONFIG_NAND=y
 CONFIG_NAND_STM32_FMC2=y
diff --git a/include/configs/stm32mp1-icore.h b/include/configs/stm32mp1-icore.h
index b56dbc7..cfc4149 100644
--- a/include/configs/stm32mp1-icore.h
+++ b/include/configs/stm32mp1-icore.h
@@ -80,6 +80,7 @@
 
 /*MMC SD*/
 #define CONFIG_SYS_MMC_MAX_DEVICE	2
+#define CONFIG_SUPPORT_EMMC_BOOT
 
 /*****************************************************************************/
 #ifdef CONFIG_DISTRO_DEFAULTS
-- 
2.17.1

