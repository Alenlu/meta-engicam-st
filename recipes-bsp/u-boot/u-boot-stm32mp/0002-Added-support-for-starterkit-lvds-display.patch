From ef958e391c07f50129f37ad173726df5d8013e92 Mon Sep 17 00:00:00 2001
From: frautel <francesco.utel@engicam.com>
Date: Fri, 10 Sep 2021 15:26:35 +0200
Subject: [PATCH] Added support for starterkit lvds display

---
 ...tm32mp157a-icore-starterkit-mx-u-boot.dtsi |  9 +++-
 .../dts/stm32mp157a-icore-starterkit-mx.dts   | 41 +++++++++++++++++++
 .../stm32mp157a-icore-starterkit-mx.dts.bak   | 14 +++++++
 3 files changed, 63 insertions(+), 1 deletion(-)

diff --git a/arch/arm/dts/stm32mp157a-icore-starterkit-mx-u-boot.dtsi b/arch/arm/dts/stm32mp157a-icore-starterkit-mx-u-boot.dtsi
index 64c6c18e11..566a48299c 100644
--- a/arch/arm/dts/stm32mp157a-icore-starterkit-mx-u-boot.dtsi
+++ b/arch/arm/dts/stm32mp157a-icore-starterkit-mx-u-boot.dtsi
@@ -91,13 +91,14 @@
 		CLK_CKPER_DISABLED
 		CLK_ETH_PLL3Q
 		CLK_SDMMC12_HCLK6
+		CLK_DSI_DSIPLL
 		CLK_STGEN_HSI
 		CLK_USBPHY_HSE
 		CLK_SPI2S1_DISABLED
 		CLK_SPI2S23_DISABLED
 		CLK_SPI45_DISABLED
 		CLK_SPI6_DISABLED
-		CLK_I2C46_DISABLED
+		CLK_I2C46_PCLK5
 		CLK_SDMMC3_HCLK2
 		CLK_USBO_USBPHY
 		CLK_ADC_DISABLED
@@ -137,6 +138,12 @@
 		cfg = < 1 49 2 11 1 PQR(1,1,0) >;
 		u-boot,dm-pre-reloc;
 	};
+	pll4:st,pll@3 {
+		compatible = "st,stm32mp1-pll";
+		reg = <3>;
+		cfg = < 1 33 3 4 3 PQR(0,1,0) >;
+		u-boot,dm-pre-reloc;
+	};
 };
 
 &sdmmc1{
diff --git a/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts b/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts
index dc8d06448d..5e7591828b 100644
--- a/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts
+++ b/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts
@@ -681,6 +681,23 @@
 &pinctrl_z {
 	u-boot,dm-pre-reloc;
 
+	i2c6_pins_z_mx: i2c6_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('Z', 6, AF2)>, /* I2C6_SCL */
+					 <STM32_PINMUX('Z', 7, AF2)>; /* I2C6_SDA */
+			bias-disable;
+			drive-open-drain;
+			slew-rate = <0>;
+		};
+	};
+
+	i2c6_sleep_pins_z_mx: i2c6_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('Z', 6, ANALOG)>, /* I2C6_SCL */
+					 <STM32_PINMUX('Z', 7, ANALOG)>; /* I2C6_SDA */
+		};
+	};
+
 	usart1_pins_z_mx: usart1_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins1 {
@@ -749,6 +766,13 @@
 	/* USER CODE END dmamux1 */
 };
 
+&dsi{
+	status = "okay";
+
+	/* USER CODE BEGIN dsi */
+	/* USER CODE END dsi */
+};
+
 &dts{
 	status = "okay";
 
@@ -846,6 +870,23 @@
 	/* USER CODE END i2c2 */
 };
 
+&i2c6{
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&i2c6_pins_z_mx>;
+	pinctrl-1 = <&i2c6_sleep_pins_z_mx>;
+	status = "okay";
+
+	/* USER CODE BEGIN i2c6 */
+	/* USER CODE END i2c6 */
+};
+
+&ltdc{
+	status = "okay";
+
+	/* USER CODE BEGIN ltdc */
+	/* USER CODE END ltdc */
+};
+
 &m_can1{
 	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&fdcan1_pins_mx>;
diff --git a/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts.bak b/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts.bak
index 874a1b5a7b..be193c8a29 100644
--- a/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts.bak
+++ b/arch/arm/dts/stm32mp157a-icore-starterkit-mx.dts.bak
@@ -749,6 +749,13 @@
 	/* USER CODE END dmamux1 */
 };
 
+&dsi{
+	status = "okay";
+
+	/* USER CODE BEGIN dsi */
+	/* USER CODE END dsi */
+};
+
 &dts{
 	status = "okay";
 
@@ -846,6 +853,13 @@
 	/* USER CODE END i2c2 */
 };
 
+&ltdc{
+	status = "okay";
+
+	/* USER CODE BEGIN ltdc */
+	/* USER CODE END ltdc */
+};
+
 &m_can1{
 	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&fdcan1_pins_mx>;
