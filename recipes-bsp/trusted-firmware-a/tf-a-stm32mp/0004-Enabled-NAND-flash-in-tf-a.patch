From b4ab6a742cc53d901fafcec4bcecf7600dee0a4e Mon Sep 17 00:00:00 2001
From: frautel <francesco.utel@engicam.com>
Date: Tue, 5 Oct 2021 17:02:23 +0200
Subject: [PATCH] Enabled NAND flash in tf-a

---
 fdts/stm32mp157a-icore-starterkit-mx.dts | 46 ++++++++++++++++++++++++
 1 file changed, 46 insertions(+)

diff --git a/fdts/stm32mp157a-icore-starterkit-mx.dts b/fdts/stm32mp157a-icore-starterkit-mx.dts
index f911ff0d3..15c8fe0f1 100644
--- a/fdts/stm32mp157a-icore-starterkit-mx.dts
+++ b/fdts/stm32mp157a-icore-starterkit-mx.dts
@@ -63,6 +63,31 @@
 }; /*root*/
 
 &pinctrl {
+	fmc_pins_mx: fmc_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('D', 0, AF12)>, /* FMC_D2 */
+					 <STM32_PINMUX('D', 1, AF12)>, /* FMC_D3 */
+					 <STM32_PINMUX('D', 4, AF12)>, /* FMC_NOE */
+					 <STM32_PINMUX('D', 5, AF12)>, /* FMC_NWE */
+					 <STM32_PINMUX('D', 11, AF12)>, /* FMC_CLE */
+					 <STM32_PINMUX('D', 12, AF12)>, /* FMC_ALE */
+					 <STM32_PINMUX('D', 14, AF12)>, /* FMC_D0 */
+					 <STM32_PINMUX('D', 15, AF12)>, /* FMC_D1 */
+					 <STM32_PINMUX('E', 7, AF12)>, /* FMC_D4 */
+					 <STM32_PINMUX('E', 8, AF12)>, /* FMC_D5 */
+					 <STM32_PINMUX('E', 9, AF12)>, /* FMC_D6 */
+					 <STM32_PINMUX('E', 10, AF12)>, /* FMC_D7 */
+					 <STM32_PINMUX('G', 9, AF12)>; /* FMC_NCE */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <1>;
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('D', 6, AF12)>; /* FMC_NWAIT */
+			bias-pull-up;
+		};
+	};
+
 	sdmmc1_pins_mx: sdmmc1_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
@@ -184,6 +209,7 @@
 	>;
 	st,pkcs = <
 		CLK_CKPER_DISABLED
+		CLK_FMC_ACLK
 		CLK_ETH_PLL3Q
 		CLK_SDMMC12_HCLK6
 		CLK_DSI_DSIPLL
@@ -253,6 +279,7 @@
 	DECPROT(STM32MP1_ETZPC_DMAMUX_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
 	DECPROT(STM32MP1_ETZPC_ETH_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
 	DECPROT(STM32MP1_ETZPC_TT_FDCAN_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
+	DECPROT(STM32MP1_ETZPC_FMC_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
 	DECPROT(STM32MP1_ETZPC_I2C2_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
 	DECPROT(STM32MP1_ETZPC_I2C6_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
 	DECPROT(STM32MP1_ETZPC_SAI2_ID, DECPROT_NS_RW, DECPROT_UNLOCK)
@@ -284,6 +311,25 @@
 	/* USER CODE END etzpc */
 };
 
+&fmc{
+	pinctrl-names = "default";
+	pinctrl-0 = <&fmc_pins_mx>;
+	status = "okay";
+
+	/* USER CODE BEGIN fmc */
+  nand-controller@4,0 {
+          status = "okay";
+
+          nand@0 {
+                  reg = <0>;
+                  nand-on-flash-bbt;
+                  #address-cells = <1>;
+                  #size-cells = <1>;
+          };
+  };
+	/* USER CODE END fmc */
+};
+
 &rcc{
 	status = "okay";
 	secure-status = "okay";
