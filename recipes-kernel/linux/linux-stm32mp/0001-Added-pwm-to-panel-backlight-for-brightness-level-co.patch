From 0ce046ab44eb01441fe45fbafea927f93ff500da Mon Sep 17 00:00:00 2001
From: Franesco Utel <francesco.utel@engicam.com>
Date: Fri, 27 May 2022 11:49:24 +0200
Subject: [PATCH] Added pwm to panel backlight for brightness level control

---
 arch/arm/boot/dts/stm32mp157a-ugea512-mx.dts | 49 +++++++++++++++++---
 1 file changed, 42 insertions(+), 7 deletions(-)

diff --git a/arch/arm/boot/dts/stm32mp157a-ugea512-mx.dts b/arch/arm/boot/dts/stm32mp157a-ugea512-mx.dts
index f6d7139d8..9c5052ef1 100644
--- a/arch/arm/boot/dts/stm32mp157a-ugea512-mx.dts
+++ b/arch/arm/boot/dts/stm32mp157a-ugea512-mx.dts
@@ -1,6 +1,6 @@
 /* SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause) */
 /*
- * Copyright (C) STMicroelectronics 2021 - All Rights Reserved
+ * Copyright (C) STMicroelectronics 2022 - All Rights Reserved
  * Author: STM32CubeMX code generation for STMicroelectronics.
  */
 
@@ -255,12 +255,16 @@
 		regulator-always-on;
 	};
 
-    backlight {
-        compatible = "gpio-backlight";
-		gpios = <&gpiod 13 GPIO_ACTIVE_HIGH>;
-        default-on;
-    };
+	panel_backlight: panel-backlight {
+	       compatible = "pwm-backlight";
+	       pwms = <&{/soc/timer@40002000/pwm} 1 1000000 0>;
+	       brightness-levels = <0 4 8 16 32 64 128 255>;
+	       default-brightness-level = <7>;
+	       status = "okay";
 
+				 power-supply = <&panel_pwr>;
+
+	};
 	/* USER CODE END root */
 
 	clocks {
@@ -604,6 +608,21 @@
 		};
 	};
 
+	tim4_pwm_pins_mx: tim4_pwm_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 13, AF2)>; /* TIM4_CH2 */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <0>;
+		};
+	};
+
+	tim4_pwm_sleep_pins_mx: tim4_pwm_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 13, ANALOG)>; /* TIM4_CH2 */
+		};
+	};
+
 	uart4_pins_mx: uart4_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins1 {
@@ -1061,6 +1080,23 @@
 	/* USER CODE END timers12 */
 };
 
+&timers4{
+	status = "okay";
+
+	/* USER CODE BEGIN timers4 */
+	/* USER CODE END timers4 */
+
+	pwm{
+		pinctrl-names = "default", "sleep";
+		pinctrl-0 = <&tim4_pwm_pins_mx>;
+		pinctrl-1 = <&tim4_pwm_sleep_pins_mx>;
+		status = "okay";
+
+		/* USER CODE BEGIN timers4_pwm */
+		/* USER CODE END timers4_pwm */
+	};
+};
+
 &uart4{
 	u-boot,dm-pre-reloc;
 	pinctrl-names = "default", "sleep";
@@ -1175,4 +1211,3 @@
 
 /* USER CODE BEGIN addons */
 /* USER CODE END addons */
-
